name: C++ Quality & Security

# description: C++ Quality & Security, including CodeQL, Cppcheck, Clang-Tidy and CVE, SBoM SPDX and CycloneDX
# Version: 1.0.0
# Author: ZHENG Robert
# License: MIT
# Date: 2026-02-08

run-name: C++ Quality & Security by ${{ github.actor }}

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget cmake ninja-build build-essential gcc-14 g++-14 libssl-dev libcurl4-openssl-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.9.*"
          host: "linux"

      - name: Build with CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-14 -DCMAKE_CXX_COMPILER=g++-14
          cmake --build build --parallel

      - name: Analyze
        uses: github/codeql-action/analyze@v4

  cppcheck:
    name: Cppcheck Static Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Cppcheck and tools
        run: sudo apt-get update && sudo apt-get install -y cppcheck jq

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev wget cmake ninja-build build-essential gcc-14 g++-14 libssl-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.9.*"
          host: "linux"

      - name: Configure CMake (generate compile_commands.json)
        run: |
          cmake -S . -B build-cppcheck -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-14 -DCMAKE_CXX_COMPILER=g++-14
          cp build-cppcheck/compile_commands.json . 2>/dev/null || true

      - name: Generate Qt autogen files (minimal build to produce moc/uis)
        run: |
          echo "=== Generating Qt autogen files (moc/uis/qrc) ==="
          cmake --build build-cppcheck --target all -- -j$(nproc) || true
          cp build-cppcheck/compile_commands.json . 2>/dev/null || true
          echo "=== Autogen generation step complete ==="

      - name: Debug - Check compile_commands.json
        run: |
          echo "=== compile_commands.json exists ==="
          if [ -f compile_commands.json ]; then
            ls -lah compile_commands.json
            echo "=== Total entries in compile_commands.json ==="
            jq 'length' compile_commands.json
            echo "=== Files in compile_commands.json (sample) ==="
            jq -r '.[].file' compile_commands.json | sort -u | head -50
          else
            echo "compile_commands.json not found, will use direct file paths"
          fi

      - name: Filter compile_commands.json (remove missing and _deps/autogen entries)
        shell: bash
        run: |
          set -euo pipefail
          CCDB="compile_commands.json"
          FILTERED="compile_commands.filtered.json"

          if [ -f "$CCDB" ] && [ "$(jq 'length' "$CCDB")" -gt 0 ]; then
            echo "Filtering compile_commands.json: keeping only entries whose files exist and excluding _deps/autogen"
            tmp=$(mktemp)

            jq -c '.[]' "$CCDB" | while IFS= read -r entry; do
              file=$(printf '%s' "$entry" | jq -r '.file')
              dir=$(printf '%s' "$entry" | jq -r '.directory')
              path="$dir/$file"

              # Normalize path using python3 -c with a single argument (YAML-safe)
              norm=$(python3 -c 'import os,sys;print(os.path.normpath(sys.argv[1]))' "$path")
              path="$norm"

              if [ -f "$path" ]; then
                printf '%s\n' "$entry"
              else
                case "$path" in
                  *"_deps/"*|*"/autogen/"*|*"/moc_"*|*"/mocs_compilation.cpp"*)
                    printf 'Skipping generated or _deps file: %s\n' "$path" >&2
                    ;;
                  *)
                    printf 'Skipping missing file: %s\n' "$path" >&2
                    ;;
                esac
              fi
            done > "$tmp"

            jq -s '.' "$tmp" > "$FILTERED"
            rm -f "$tmp"

            if [ "$(jq 'length' "$FILTERED")" -gt 0 ]; then
              mv "$FILTERED" "$CCDB"
              echo "Filtered compile_commands.json written (entries: $(jq 'length' "$CCDB"))"
            else
              echo "Filtered compile_commands.json is empty; removing and falling back to direct paths"
              rm -f "$FILTERED" "$CCDB"
            fi
          else
            echo "No compile_commands.json found or file is empty"
          fi

      - name: Run Cppcheck
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Starting Cppcheck Analysis ==="
      
          REPORT="cppcheck-report.txt"
          FILELIST="cppcheck-filelist.txt"
          rm -f "$REPORT" "$FILELIST"
      
          # Helper: create file list from compile_commands.json (only existing files)
          create_filelist_from_ccdb() {
            CCDB="$1"
            echo "Creating file list from $CCDB"
            jq -r '.[].file' "$CCDB" 2>/dev/null | while IFS= read -r f; do
              # If path is relative in compile_commands, try directory field
              if [ -z "$f" ]; then continue; fi
              # Try as-is, then try relative to directory in entry
              if [ -f "$f" ]; then
                printf '%s\n' "$f"
              else
                # try to resolve via directory field
                # get directory for this file entry
                dir=$(jq -r --arg file "$f" '.[] | select(.file==$file) | .directory' "$CCDB" 2>/dev/null | head -n1)
                if [ -n "$dir" ] && [ -f "$dir/$f" ]; then
                  printf '%s\n' "$dir/$f"
                else
                  # try basename search (fallback)
                  if [ -f "$(basename "$f")" ]; then
                    printf '%s\n' "$(basename "$f")"
                  else
                    echo "Skipping missing file from CCDB: $f" >&2
                  fi
                fi
              fi
            done | sort -u > "$FILELIST"
          }
      
          # Helper: create file list by scanning source dirs
          create_filelist_from_dirs() {
            echo "Scanning source directories for .cpp/.c/.h/.hpp files"
            # adjust patterns if you use other extensions
            find cli include tests -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.h' -o -name '*.hpp' \) 2>/dev/null | sort -u > "$FILELIST" || true
          }
      
          # 1) Try compile_commands.json if present and non-empty
          if [ -f compile_commands.json ] && [ "$(jq 'length' compile_commands.json)" -gt 0 ]; then
            echo "Using compile_commands.json for analysis"
            create_filelist_from_ccdb compile_commands.json
          else
            echo "compile_commands.json is empty or missing, will scan source directories"
            create_filelist_from_dirs
          fi
      
          # If filelist is empty, try scanning common source dirs as fallback
          if [ ! -s "$FILELIST" ]; then
            echo "No files found from compile_commands.json. Trying fallback directories."
            create_filelist_from_dirs
          fi
      
          # Final check: if still empty, abort gracefully (no files to analyze)
          if [ ! -s "$FILELIST" ]; then
            echo "No source files found for cppcheck. Skipping analysis."
            echo "No files" > "$REPORT"
            exit 0
          fi
      
          echo "Files to analyze (sample):"
          head -30 "$FILELIST"
      
          # Run cppcheck using --file-list (safer for many files)
          cppcheck \
            --enable=all \
            --inconclusive \
            --std=c++23 \
            --file-list="$FILELIST" \
            --error-exitcode=0 \
            --report-progress \
            2>&1 | tee "$REPORT"
      
          echo "=== Cppcheck Analysis Complete ==="
          echo "=== Report Statistics ==="
          LINES=$(wc -l < "$REPORT" || echo 0)
          echo "Report has $LINES lines"
      
          if [ "$LINES" -gt 0 ]; then
            echo "=== Sample Output (first 30 lines) ==="
            head -30 "$REPORT"
          else
            echo "‚úÖ Analysis completed with no issues found"
          fi
  
      - name: Upload Cppcheck Report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

  clang_tidy:
    name: Clang-Tidy Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang & Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy nlohmann-json3-dev \
            libcurl4-openssl-dev wget cmake ninja-build build-essential \
            gcc-14 g++-14 libssl-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.9.*"
          host: "linux"

      - name: Configure CMake (export compile_commands.json)
        run: |
          cmake -S . -B build-clangtidy \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14
          cp build-clangtidy/compile_commands.json .

      - name: Debug - Check compile_commands.json
        run: |
          echo "=== compile_commands.json exists ==="
          ls -lah compile_commands.json || echo "File not found!"
          echo "=== compile_commands.json content (first 30 lines) ==="
          head -30 compile_commands.json
          echo "=== Files to analyze ==="
          jq -r '.[].file' compile_commands.json 2>/dev/null | head -10

      - name: Run Clang-Tidy
        shell: bash
        run: |
          echo "=== Starting Clang-Tidy Analysis ==="

          FILES=$(jq -r '.[].file' build-clangtidy/compile_commands.json 2>/dev/null | sort -u)

          if [ -z "$FILES" ]; then
            echo "ERROR: No files found in compile_commands.json"
            exit 1
          fi

          echo "Files to analyze:"
          echo "$FILES"

          echo "$FILES" | xargs clang-tidy -p build-clangtidy --quiet 2>&1 | tee clang-tidy-report.txt || true

          echo "=== Clang-Tidy Analysis Complete ==="
          echo "=== Report Statistics ==="
          LINES=$(wc -l < clang-tidy-report.txt)
          echo "Total lines in report: $LINES"

          if [ "$LINES" -eq 0 ]; then
            echo "No issues found (or report is empty)"
          else
            echo "=== Issues Found ==="
            head -20 clang-tidy-report.txt
          fi

      - name: Upload Clang-Tidy Report
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-report
          path: clang-tidy-report.txt

  sbom:
    name: Generate SBOM (SPDX & CycloneDX)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=1.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev wget cmake ninja-build build-essential gcc-14 g++-14 libssl-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.9.*"
          host: "linux"

      - name: Configure CMake (export compile_commands)
        run: |
          cmake -S . -B build \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          cmake --build build --config Release

      - name: Setup Python (f√ºr reuse)
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Node.js v24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install SBOM Tools
        run: |
          pip install reuse
          npm install -g @cyclonedx/cdxgen

      - name: Prepare Output Directory
        run: mkdir -p sbom-output

      - name: Generate SPDX SBOM
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Generating SPDX SBOM with version: $version"

          reuse spdx -o "./sbom-output/spdx-${version}.spdx" || {
            echo "‚ö†Ô∏è  SPDX generation failed (this may be OK if REUSE is not configured)"
            {
              echo "SPDXVersion: SPDX-2.3"
              echo "DataLicense: CC0-1.0"
              echo "SPDXID: SPDXRef-DOCUMENT"
              echo "DocumentName: Project SBOM"
              echo "DocumentNamespace: https://example.org/sbom-${version}"
              echo "Creator: Tool reuse"
            } > "./sbom-output/spdx-${version}.spdx"
          }

          if [ -f "./sbom-output/spdx-${version}.spdx" ]; then
            echo "‚úÖ SPDX SBOM created"
            ls -lah "./sbom-output/spdx-${version}.spdx"
          fi

      - name: Generate CycloneDX SBOM
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Generating CycloneDX SBOM with version: $version"

          cdxgen -t cpp -o "./sbom-output/cyclonedx-${version}.json" build/ || {
            echo "‚ö†Ô∏è  CycloneDX generation failed, creating minimal SBOM"
            timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            printf '{\n' > "./sbom-output/cyclonedx-${version}.json"
            printf '  "bomFormat": "CycloneDX",\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '  "specVersion": "1.6",\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '  "version": 1,\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '  "metadata": {\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '    "timestamp": "%s",\n' "$timestamp" >> "./sbom-output/cyclonedx-${version}.json"
            printf '    "component": {\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '      "type": "application",\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '      "name": "project",\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '      "version": "%s"\n' "$version" >> "./sbom-output/cyclonedx-${version}.json"
            printf '    }\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '  },\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '  "components": []\n' >> "./sbom-output/cyclonedx-${version}.json"
            printf '}\n' >> "./sbom-output/cyclonedx-${version}.json"
          }

          if [ -f "./sbom-output/cyclonedx-${version}.json" ]; then
            echo "‚úÖ CycloneDX SBOM created"
            ls -lah "./sbom-output/cyclonedx-${version}.json"
            echo ""
            echo "=== SBOM Preview ==="
            head -20 "./sbom-output/cyclonedx-${version}.json"
          fi

      - name: SBOM Generation Summary
        run: |
          echo "=== SBOM Generation Complete ==="
          echo ""
          echo "Generated files:"
          ls -lah sbom-output/
          echo ""
          echo "File sizes:"
          du -h sbom-output/*

      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-files
          path: |
            sbom-output/spdx-*.spdx
            sbom-output/cyclonedx-*.json
          retention-days: 90

  cvecheck:
    name: CVE Vulnerability Scan
    runs-on: ubuntu-latest
    needs: [sbom]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=1.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Download SBOM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-files
          path: sbom-input/

      - name: Verify SBOM Files
        run: |
          echo "=== Downloaded SBOM Files ==="
          ls -lah sbom-input/
          echo ""

          version="${{ steps.version.outputs.version }}"
          if [ ! -f "sbom-input/cyclonedx-${version}.json" ]; then
            echo "‚ö†Ô∏è  CycloneDX SBOM not found!"
            exit 1
          fi

          echo "‚úÖ CycloneDX SBOM found"
          echo "=== SBOM Content Preview ==="
          head -20 "sbom-input/cyclonedx-${version}.json"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install CVE Binary Tool
        run: |
          pip install cve-bin-tool

      - name: CVE Report (Critical CVSS >= 9)
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "=== Scanning for CRITICAL CVEs (CVSS >= 9) ==="

          cve-bin-tool --sbom cyclonedx \
            --sbom-file "sbom-input/cyclonedx-${version}.json" \
            --format json \
            --output "cve-report-critical-${version}.json" \
            --disable-data-source OSV,EPSS \
            --cvss 9 || true

          echo "=== Critical CVE Report Generated ==="
          if [ -f "cve-report-critical-${version}.json" ]; then
            SIZE=$(wc -c < "cve-report-critical-${version}.json")
            echo "Report file size: $SIZE bytes"

            if [ "$SIZE" -gt 10 ]; then
              echo "‚ö†Ô∏è  WARNING: Critical CVEs found!"
              head -50 "cve-report-critical-${version}.json"
            else
              echo "‚úÖ No critical CVEs found (CVSS >= 9)"
            fi
          fi

      - name: CVE Report (All Vulnerabilities - Informational)
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "=== Scanning for ALL CVEs ==="

          cve-bin-tool --sbom cyclonedx \
            --sbom-file "sbom-input/cyclonedx-${version}.json" \
            --format json \
            --output "cve-report-all-${version}.json" \
            --disable-data-source OSV,EPSS \
            --cvss 0 || true

          echo "=== ALL CVEs Report Generated ==="
          if [ -f "cve-report-all-${version}.json" ]; then
            SIZE=$(wc -c < "cve-report-all-${version}.json")
            echo "Report file size: $SIZE bytes
            
            if [ "$SIZE" -gt 10 ]; then
              echo "üìä Summary of all vulnerabilities:"
              grep -o '"vulnerability"' "cve-report-all-${version}.json" | wc -l || echo "Unable to count CVEs"
            else
              echo "‚úÖ No vulnerabilities found at any level"
            fi
          fi

      - name: Create CVE Summary Report
        run: |
          version="${{ steps.version.outputs.version }}"

          echo "=== CVE SCAN SUMMARY ===" > cve-summary-${version}.txt
          echo "" >> cve-summary-${version}.txt
          echo "Scan Date: $(date)" >> cve-summary-${version}.txt
          echo "SBOM File: cyclonedx-${version}.json" >> cve-summary-${version}.txt
          echo "Tool: cve-bin-tool" >> cve-summary-${version}.txt
          echo "" >> cve-summary-${version}.txt

          echo "CRITICAL VULNERABILITIES (CVSS >= 9):" >> cve-summary-${version}.txt
          if [ -f "cve-report-critical-${version}.json" ]; then
            SIZE=$(wc -c < "cve-report-critical-${version}.json")
            if [ "$SIZE" -gt 10 ]; then
              echo "‚ö†Ô∏è  Found - see cve-report-critical-${version}.json" >> cve-summary-${version}.txt
            else
              echo "‚úÖ None found" >> cve-summary-${version}.txt
            fi
          fi

          echo "" >> cve-summary-${version}.txt
          echo "ALL VULNERABILITIES (CVSS >= 0):" >> cve-summary-${version}.txt
          if [ -f "cve-report-all-${version}.json" ]; then
            SIZE=$(wc -c < "cve-report-all-${version}.json")
            if [ "$SIZE" -gt 10 ]; then
              COUNT=$(grep -o '"vulnerability"' "cve-report-all-${version}.json" | wc -l || echo "0")
              echo "Found $COUNT vulnerabilities - see cve-report-all-${version}.json" >> cve-summary-${version}.txt
            else
              echo "‚úÖ None found" >> cve-summary-${version}.txt
            fi
          fi

          echo ""
          cat cve-summary-${version}.txt

      - name: Upload CVE Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cve-reports
          path: |
            cve-report-critical-*.json
            cve-report-all-*.json
            cve-summary-*.txt
          retention-days: 90

  release:
    name: Create Release with SBOM & CVE Reports
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [codeql, cppcheck, clang_tidy, sbom, cvecheck]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download SBOM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-files
          path: artifacts/sbom/

      - name: Download CVE Report Artifacts
        uses: actions/download-artifact@v4
        with:
          name: cve-reports
          path: artifacts/cve/

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          version="${{ steps.version.outputs.version }}"

          echo "=== Collecting release assets for version: $version ==="
          echo ""

          # Copy SBOM files
          echo "=== SBOM Files ==="
          for file in artifacts/sbom/spdx-${version}.spdx artifacts/sbom/cyclonedx-${version}.json; do
            if [ -f "$file" ]; then
              cp "$file" release-assets/
              echo "‚úì Copied $(basename $file)"
            else
              echo "‚ö†Ô∏è  Not found: $file"
            fi
          done

          echo ""
          echo "=== CVE Reports ==="
          for file in artifacts/cve/cve-report-critical-${version}.json \
                      artifacts/cve/cve-report-all-${version}.json \
                      artifacts/cve/cve-summary-${version}.txt; do
            if [ -f "$file" ]; then
              cp "$file" release-assets/
              echo "‚úì Copied $(basename $file)"
            else
              echo "‚ö†Ô∏è  Not found: $file"
            fi
          done

          echo ""
          echo "=== Additional Files ==="
          if [ -f "CHANGELOG.md" ]; then
            cp CHANGELOG.md release-assets/
            echo "‚úì Copied CHANGELOG.md"
          else
            echo "‚ö†Ô∏è  CHANGELOG.md not found"
          fi

          echo ""
          echo "=== Release Assets Summary ==="
          ls -lah release-assets/
          echo ""
          echo "Total files: $(ls release-assets/ | wc -l)"

      - name: Extract Release Notes from CHANGELOG
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Extracting release notes for version: $version"
      
          if [ -f "CHANGELOG.md" ]; then
            # Extract section for the version header "## [<version>]" until the next "## [" header
            sed -n "/^##  \[$version\]/,/^## \[/p" CHANGELOG.md | sed '$ d' > release_notes.txt
      
            # If extraction produced nothing, create a default release note
            if [ ! -s release_notes.txt ]; then
              echo "## Release v$version" > release_notes.txt
              echo "" >> release_notes.txt
              echo "See CHANGELOG.md for details." >> release_notes.txt
            fi
          else
            echo "## Release v$version" > release_notes.txt
            echo "" >> release_notes.txt
            echo "No CHANGELOG.md found." >> release_notes.txt
          fi

          echo "" >> release_notes.txt
          echo "### üì¶ Software Bill of Materials (SBOM)" >> release_notes.txt
          echo "This release includes:" >> release_notes.txt
          echo "- SPDX SBOM: \`spdx-${version}.spdx\`" >> release_notes.txt
          echo "- CycloneDX SBOM: \`cyclonedx-${version}.json\`" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "### üîí Security Scan" >> release_notes.txt
          echo "CVE vulnerability reports are attached to this release." >> release_notes.txt
      
          echo ""
          echo "=== Release Notes Preview ==="
          cat release_notes.txt


      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release v${{ steps.version.outputs.version }}"
          body_path: release_notes.txt
          draft: false
          prerelease: false
          files: |
            release-assets/CHANGELOG.md
            release-assets/spdx-*.spdx
            release-assets/cyclonedx-*.json
            release-assets/cve-report-*.json
            release-assets/cve-summary-*.txt
